#!/bin/bash
# This file is managed by Puppet, do not edit!
# Commands pulled from https://open.xdmod.org/8.1/storage.html

set -e

STORAGE_LOG_DIRECTORY="$1"
if [ "x${STORAGE_LOG_DIRECTORY}" = "x" ]; then
  STORAGE_LOG_DIRECTORY=<%= scope['xdmod::storage_log_directory'] %>
fi

for f in `find $STORAGE_LOG_DIRECTORY -maxdepth 1 -type f` ; do
  resource=$(cat $f | jq -r '.[0].resource')
  xdmod-shredder -f storage -r $resource -i $f
done

last_modified_start_date=$(date +'%F %T')
xdmod-ingestor --datatype storage
xdmod-ingestor --aggregate=storage --last-modified-start-date "$last_modified_start_date"
